<html>
	<head>
	    <title>Lights</title>
	    <link rel="stylesheet" type="text/css" href="styles/css/foundation.css">
	    <script type="text/javascript" src="lights.js"></script>
	    <script type='text/javascript' src="assets/js/EventEmitter/EventEmitter.js"></script>
	    <script type="text/javascript" src="requests.js"></script>
	    <script type="text/javascript" src="http://yandex.st/jquery/1.6.2/jquery.min.js"></script>
	    <script>
	        $(document).ready(function(){
	            $("body").css("display","none").fadeIn("slow");
	        });
	    </script>
	</head>
	<body>
		<div align='center'>
			<h1>Hi, it's simple lights with some logic on server </h1>
				<a id='begin' style="width:100px;height:50px" onclick='light.toRed()' class='button secondary expand'>	Start
				</a>
				<a id='stop' onclick='light.stop()' style="width:100px;height:50px" class='medium alert button'> Stop </a>
				<h3> State is: <p style="width:50px;height:30px;background-color:white" id="color">default</p> </h3>
				<p> Tram state changes every 3 sec, it checks every 10 sec </p>
				<p> Tram mod work 3 sec after emit + 5 sec in green state. In end it backs in last state </p>
				<h4 id='info'>Tram mode off</h4>
		</div>
	</body>
	<script>
			var light = new svetophor(2500, 1500, 2500);
			var Light_Events = new EventEmitter;
			Light_Events.on('tram', light.tram_is_coming.bind(light));
			function ChangeStateOnHtml() {
		        document.getElementById('color').innerHTML = light.getState();
		        if (light.getState() == 'Red')
		                color.style.backgroundColor='#FF6A6A';
		        if (light.getState() == 'Yellow')
		                color.style.backgroundColor='yellow';
		        if (light.getState() == 'Green')
		                color.style.backgroundColor='#00FF00';
			};
			function AskTram(address, port, callbackk){
		        var xmlhttp = getXmlHttp()
		        xmlhttp.open('GET', 'http://'+ address + ':' + port, true);
		        xmlhttp.onreadystatechange = function() {
		                if (xmlhttp.readyState == 4) {
		                        if(xmlhttp.status == 200) {
		                                if (xmlhttp.responseText == 'true'){
		                                        Light_Events.emit('tram');
		                                        document.getElementById('info').innerHTML = 'Tram mode on';
		                                        setTimeout(function(){document.getElementById('info').innerHTML = 'Tram mode off'}, 8000);
		                                }
		                                else{
		                                	document.getElementById('info').innerHTML = 'Tram mode off';
		                                }
		                        }
		                        else
		                        	alert('Server is down, maybe')
		                }
	        };
	        	xmlhttp.send(null);
			};
	    	window.onclick = function(e){
				var elem = e ? e.target : window.event.srcElement;
				var checker_tram;
				var checker_state;
				if (elem.id == 'begin'){
					this.checker_tram = setInterval(function(){AskTram('127.0.0.1', 8000)}, 10000);
					this.checker_state = setInterval(function(){ChangeStateOnHtml()}, 500);
				}
				else{
					clearInterval(this.checker_tram);
					color.style.backgroundColor='white';
					document.getElementById('info').innerHTML = 'Tram mode off';
				}
			}
	</script>
</html>